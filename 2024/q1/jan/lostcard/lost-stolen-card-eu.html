<body>
    <script>
    /* utility functions */
    const getDomain = () => {
      const domain = location.hostname;
    
      if (domain.includes("deriv.com")) {
        return "deriv.com";
      }
    
      return domain.includes("binary.sx") ? "binary.sx" : domain;
    };
    
    const eraseCookie = (name) => {
      document.cookie = `${name}=; Max-Age=-99999999; domain=${getDomain()}; path=/;`;
    };
    
    const getCookie = (name) => {
      const dc = document.cookie;
      const prefix = name + "=";
    
      // check begin index
      let begin = dc.indexOf("; " + prefix);
      if (begin == -1) {
        begin = dc.indexOf(prefix);
        // cookie not available
        if (begin != 0) return null;
      } else {
        begin += 2;
      }
    
      // check end index
      let end = document.cookie.indexOf(";", begin);
      if (end == -1) {
        end = dc.length;
      }
    
      return decodeURI(dc.substring(begin + prefix.length, end));
    };
    
    const isMobile = () => {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      );
    };
    
    const toISOFormat = (date) => {
      if (date instanceof Date) {
        const utc_year = date.getUTCFullYear();
        const utc_month =
          (date.getUTCMonth() + 1 < 10 ? "0" : "") + (date.getMonth() + 1);
        const utc_date = (date.getUTCDate() < 10 ? "0" : "") + date.getUTCDate();
    
        return `${utc_year}-${utc_month}-${utc_date}`;
      }
    
      return "";
    };
    
    const shouldOverwrite = (new_utm_data, current_utm_data) => {
      if (!current_utm_data) {
          return true;
      } else if (!new_utm_data) {
          return false;
      }
      
      // Check if both new and old utm_data has all required fields
      const required_fields = ['utm_source', 'utm_medium', 'utm_campaign'];
      const has_new_required_fields = required_fields.every((field) => new_utm_data[field]);
      const has_curr_required_fields = required_fields.every((field) => current_utm_data[field]);
    
      // Overwrite based on the order of priority
      if (has_new_required_fields && has_curr_required_fields) {
          if (new_utm_data.utm_medium.includes('aff')) return true; // 1. Affiliate tags
          else if (new_utm_data.utm_medium.includes('ppc') && !current_utm_data.utm_medium.includes('aff')) return true; // 2. PPC tags
          else if (!current_utm_data.utm_medium.includes('ppc') && !current_utm_data.utm_medium.includes('aff')) return true; // 3. Complete set of required tags
      } else if (has_new_required_fields) {
          return true;
      } else if (has_curr_required_fields) {
          return false;
      } else if (new_utm_data.utm_source !== undefined
          && Object.values(new_utm_data).length >= Object.values(current_utm_data).length) return true; // 4. Everything else
      return false;
    };
    /* end utility functions */
    
    (function initMarketingCookies() {
      const searchParams = new URLSearchParams(window.location.search);
      const brand_name = "deriv";
      const app_id = 11780;
    
      /* start handling UTMs */
      const utm_fields = [
        "utm_source",
        "utm_medium",
        "utm_campaign",
        "utm_term",
        "utm_content",
        "utm_ad_id",
        "utm_click_id",
        "utm_adgroup_id",
        "utm_campaign_id",
      ];
    
      let utm_data = {};
      const current_utm_data = JSON.parse(getCookie("utm_data"));
    
      // If the user comes to the site for the first time without any URL params
      // Only set the utm_source to referrer if the user does not have utm_data cookies stored
      utm_data["utm_source"] = document.referrer? document.referrer: "null";
    
      // If the user has any new UTM params, store them
      utm_fields.forEach((field) => {
        if (searchParams.has(field)) {
          utm_data[field] = searchParams
            .get(field)
            .replace(/[^a-zA-Z0-9\s\-\.\_]/gi, "")
            .substring(0, 100); // Limit to 100 supported characters
        }
      });
    
      if (shouldOverwrite(utm_data, current_utm_data)) {
        eraseCookie("utm_data");
    
        const utm_data_cookie = encodeURI(JSON.stringify(utm_data))
          .replaceAll("%2C", ",")
          .replaceAll("%7B", "{")
          .replaceAll("%7D", "}");
    
        // Non-expiring cookie for utm_data
        // Max 400 days
        document.cookie = `utm_data=${utm_data_cookie}; expires=Tue, 19 Jan 9999 03:14:07 UTC; domain=${getDomain()}; path=/; SameSite=None; Secure;`;
      }
    
      /* end handling UTMs */
    
      /* start handling affiliate tracking */
      if (searchParams.has("t")) {
        eraseCookie("affiliate_tracking");
        document.cookie = `affiliate_tracking=${searchParams.get("t")};domain=${getDomain()}; path=/; SameSite=None; Secure;`;
      }
      /* end handling affiliate tracking */
    
      /* start handling signup device */
      const signup_device_cookie_unparsed = getCookie("signup_device") || "{}";
      const signup_device_cookie = JSON.parse(
        decodeURI(signup_device_cookie_unparsed).replaceAll("%2C", ",")
      );
      if (!signup_device_cookie.signup_device) {
        const signup_data = {
          signup_device: isMobile() ? "mobile" : "desktop",
        };
        const signup_data_cookie = encodeURI(JSON.stringify(signup_data))
          .replace(",", "%2C")
          .replace("%7B", "{")
          .replace("%7D", "}");
    
        document.cookie = `signup_device=${signup_data_cookie};domain=${getDomain()}; path=/; SameSite=None; Secure;`;
      }
      /* end handling signup device */
    
      /* start handling date first contact */
      const date_first_contact_cookie_unparsed =
        getCookie("date_first_contact") || "{}";
      const date_first_contact_cookie = JSON.parse(
        decodeURI(date_first_contact_cookie_unparsed).replaceAll("%2C", ",")
      );
    
      if (!date_first_contact_cookie.date_first_contact) {
        const ws = new WebSocket(
          `wss://green.binaryws.com/websockets/v3?app_id=${app_id}&brand=${brand_name}`
        );
    
        ws.onopen = function (evt) {
          ws.send(JSON.stringify({ time: 1 }));
        };
    
        ws.onmessage = function (msg) {
          const date_first_contact_response = JSON.parse(msg.data);
    
          const date_first_contact_data = {
            date_first_contact: toISOFormat(
              new Date(date_first_contact_response.time * 1000)
            ),
          };
    
          const date_first_contact_data_cookie = encodeURI(
            JSON.stringify(date_first_contact_data)
          )
            .replace(",", "%2C")
            .replace("%7B", "{")
            .replace("%7D", "}");
    
          document.cookie = `date_first_contact=${date_first_contact_data_cookie};domain=${getDomain()}; path=/; SameSite=None; Secure;`;
    
          ws.close();
        };
      }
      /* end handling date first contact */
    
      /* start handling gclid */
      if (searchParams.has("gclid")) {
        eraseCookie("gclid");
        document.cookie = `gclid=${searchParams.get(
          "gclid"
        )};domain=${getDomain()}; path=/; SameSite=None; Secure;`;
      }
      /* end handling gclid */
    })();
    </script>
    </body>

    <script>
    /*!
     * JavaScript Cookie v2.2.1
     * https://github.com/js-cookie/js-cookie
     *
     * Copyright 2006, 2015 Klaus Hartl & Fagner Brack
     * Released under the MIT license
     */
    (function (factory) {
        var registeredInModuleLoader;
        if (typeof define === "function" && define.amd) {
            define(factory);
            registeredInModuleLoader = true;
        }
        if (typeof exports === "object") {
            module.exports = factory();
            registeredInModuleLoader = true;
        }
        if (!registeredInModuleLoader) {
            var OldCookies = window.Cookies;
            var api = (window.Cookies = factory());
            api.noConflict = function () {
                window.Cookies = OldCookies;
                return api;
            };
        }
    })(function () {
        function extend() {
            var i = 0;
            var result = {};
            for (; i < arguments.length; i++) {
                var attributes = arguments[i];
                for (var key in attributes) {
                    result[key] = attributes[key];
                }
            }
            return result;
        }

        function decode(s) {
            return s.replace(/(%[0-9A-Z]{2})+/g, decodeURIComponent);
        }

        function init(converter) {
            function api() { }

            function set(key, value, attributes) {
                if (typeof document === "undefined") {
                    return;
                }

                attributes = extend(
                    {
                        path: "/",
                    },
                    api.defaults,
                    attributes
                );

                if (typeof attributes.expires === "number") {
                    attributes.expires = new Date(
                        new Date() * 1 + attributes.expires * 864e5
                    );
                }

                // We're using "expires" because "max-age" is not supported by IE
                attributes.expires = attributes.expires
                    ? attributes.expires.toUTCString()
                    : "";

                try {
                    var result = JSON.stringify(value);
                    if (/^[\{\[]/.test(result)) {
                        value = result;
                    }
                } catch (e) { }

                value = converter.write
                    ? converter.write(value, key)
                    : encodeURIComponent(String(value)).replace(
                        /%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,
                        decodeURIComponent
                    );

                key = encodeURIComponent(String(key))
                    .replace(/%(23|24|26|2B|5E|60|7C)/g, decodeURIComponent)
                    .replace(/[\(\)]/g, escape);

                var stringifiedAttributes = "";
                for (var attributeName in attributes) {
                    if (!attributes[attributeName]) {
                        continue;
                    }
                    stringifiedAttributes += "; " + attributeName;
                    if (attributes[attributeName] === true) {
                        continue;
                    }

                    // Considers RFC 6265 section 5.2:
                    // ...
                    // 3.  If the remaining unparsed-attributes contains a %x3B (";")
                    //     character:
                    // Consume the characters of the unparsed-attributes up to,
                    // not including, the first %x3B (";") character.
                    // ...
                    stringifiedAttributes += "=" + attributes[attributeName].split(";")[0];
                }

                return (document.cookie = key + "=" + value + stringifiedAttributes);
            }

            function get(key, json) {
                if (typeof document === "undefined") {
                    return;
                }

                var jar = {};
                // To prevent the for loop in the first place assign an empty array
                // in case there are no cookies at all.
                var cookies = document.cookie ? document.cookie.split("; ") : [];
                var i = 0;

                for (; i < cookies.length; i++) {
                    var parts = cookies[i].split("=");
                    var cookie = parts.slice(1).join("=");

                    if (!json && cookie.charAt(0) === '"') {
                        cookie = cookie.slice(1, -1);
                    }

                    try {
                        var name = decode(parts[0]);
                        cookie =
                            (converter.read || converter)(cookie, name) || decode(cookie);

                        if (json) {
                            try {
                                cookie = JSON.parse(cookie);
                            } catch (e) { }
                        }

                        jar[name] = cookie;

                        if (key === name) {
                            break;
                        }
                    } catch (e) { }
                }

                return key ? jar[key] : jar;
            }

            api.set = set;
            api.get = function (key) {
                return get(key, false /* read as raw */);
            };
            api.getJSON = function (key) {
                return get(key, true /* read as json */);
            };
            api.remove = function (key, attributes) {
                set(
                    key,
                    "",
                    extend(attributes, {
                        expires: -1,
                    })
                );
            };

            api.defaults = {};

            api.withConverter = init;

            return api;
        }

        return init(function () { });
    });

    const CookieStorage = function (cookie_name, cookie_domain = "") {
        const hostname = window.location.hostname;
        const is_deriv_com = String(hostname).includes("deriv.com");
        const is_binary_sx = String(hostname).includes("binary.sx");

        this.initialized = false;
        this.cookie_name = cookie_name;
        if (is_deriv_com) {
            this.domain = "deriv.com";
        } else if (is_binary_sx) {
            this.domain = "binary.sx";
        } else {
            this.domain = cookie_domain ?? String(hostname);
        }
        this.path = "/";
        this.same_site = "none";
        this.is_secure = true;
        this.expires = new Date("Thu, 1 Jan 2037 12:00:00 GMT");
        this.value = {};
    };

    CookieStorage.prototype = {
        initialize() {
            const cookie_value = Cookies.get(this.cookie_name);
            try {
                this.value = cookie_value ? JSON.parse(cookie_value) : {};
            } catch (e) {
                this.value = {};
            }
            this.initialized = true;
        },
        write(val, expiry_date, is_secure, sameSite) {
            if (!this.initialized) this.initialize();
            this.value = val;
            if (expiry_date) this.expires = expiry_date;
            Cookies.set(this.cookie_name, this.value, {
                expires: this.expires,
                path: this.path,
                domain: this.domain,
                secure: !!is_secure,
                sameSite: sameSite || "strict",
            });
        },
        get(key) {
            if (!this.initialized) this.initialize();
            return this.value[key];
        },
        set(key, val, options) {
            if (!this.initialized) this.initialize();
            this.value[key] = val;
            Cookies.set(this.cookie_name, this.value, {
                expires: new Date(this.expires),
                path: this.path,
                domain: this.domain,
                secure: this.is_secure,
                sameSite: this.same_site,
                ...options,
            });
        },
        remove() {
            Cookies.remove(this.cookie_name, {
                path: this.path,
                domain: this.domain,
            });
        },
    };

    const getCookiesFields = () => [
        "date_first_contact",
        "signup_device",
        "gclid",
        "utm_source",
        "utm_ad_id",
        "utm_adgroup_id",
        "utm_adrollclk_id",
        "utm_campaign",
        "utm_campaign_id",
        "utm_content",
        "utm_fbcl_id",
        "utm_gl_client_id",
        "utm_medium",
        "utm_msclk_id",
        "utm_term",
    ];

    const getCookiesObject = (cookies) => {
        const cookies_objects = {};

        cookies.forEach((cookie_name) => {
            const cookie_object = new CookieStorage(
                cookie_name.includes("utm") ? "utm_data" : cookie_name
            );
            cookies_objects[cookie_name] = cookie_object;
        });

        return cookies_objects;
    };

    const getDataObjFromCookies = (cookies, fields) => {
        const data = {};
        fields.forEach((elem) => {
            if (cookies[elem].get(elem)) {
                data[elem] = cookies[elem].get(elem);
            }
        });
        return data;
    };

    const getVerifyEmailRequest = (formatted_email) => {
        const affiliate_token = Cookies.getJSON("affiliate_tracking");

        const cookies = getCookiesFields();
        const cookies_objects = getCookiesObject(cookies);
        const cookies_value = getDataObjFromCookies(cookies_objects, cookies);

        const fields = [
            "date_first_contact",
            "signup_device",
            "gclid",
            "utm_source",
            "utm_ad_id",
            "utm_adgroup_id",
            "utm_adrollclk_id",
            "utm_campaign",
            "utm_campaign_id",
            "utm_content",
            "utm_fbcl_id",
            "utm_gl_client_id",
            "utm_medium",
            "utm_msclk_id",
            "utm_term",
        ];

        let url_parameters = {};

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        fields.map((fld) => {
            const fld_value = urlParams.get(fld);

            if (fld_value) {
                url_parameters[fld] = fld_value;
            }
        });


        return {
            verify_email: formatted_email,
            type: "account_opening",
            url_parameters: {
                ...(affiliate_token && { affiliate_token: affiliate_token }),
                ...(cookies_value && { ...cookies_value }),
                ...url_parameters
            },
        };
    };

    const initializeWebSocket = () => {
        window.ws = new WebSocket(
            "wss://blue.derivws.com/websockets/v3?app_id=16929&l=en&brand=deriv"
        );

        window.ws.onmessage = (message) => {
            const response = JSON.parse(message.data);

            if (response.msg_type === "error") {
                window.ws.close();
            }

            if (response.msg_type === "verify_email") {
                const email = response.echo_req.verify_email;

                const newUrl = `${window.location.origin}/verify-email`;
                const searchParams = new URLSearchParams({ email });
                window.location.assign(`${newUrl}?${searchParams}`);
            }
        };

        window.ws.onclose = () => setTimeout(() => initializeWebSocket(), 1000);
    }

    initializeWebSocket();
</script>